fastlane_version '2.157'
default_platform :ios

platform :ios do
  desc 'Builds project and executes unit tests for all modules in SwiftHub/Modules'
  lane :unit_test do |options|

    project_root = File.expand_path("..", Dir.pwd)
    
    modules_dir = File.join(project_root, "SwiftHub", "Modules")
    result_output_dir = File.join(project_root, "fastlane", "test_output")

    FileUtils.mkdir_p(result_output_dir) unless File.directory?(result_output_dir)

    # Finds out the project root path and discover schemes dynamically on modules_dir
    test_schemes = Dir.glob("#{modules_dir}/*")
                       .select { |f| File.directory?(f) }
                       .map { |path| File.basename(path) }

    # Runs tests of each found scheme
    test_schemes.each do |scheme|
      UI.message("⚙️ Running tests for scheme: #{scheme}")
      
      package_dir = File.join(modules_dir, scheme)
      
      result_bundle_path = File.join(result_output_dir, "#{scheme}.xcresult")
      
      # Removes olds
      FileUtils.rm_rf(result_bundle_path) if File.exist?(result_bundle_path)

      scan(
        scheme: scheme,
        package_path: package_dir, 
        sdk: "iphonesimulator",
        device: "iPhone 15 Pro (17.0)",
        code_coverage: true,
        prelaunch_simulator: true,
        clean: options[:clean],
        skip_package_dependencies_resolution: options[:skip_package_dependencies_resolution],
        result_bundle: true,
        result_bundle_path: result_bundle_path 
      )
    end
  end
end
